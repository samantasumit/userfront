<html>

<head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.2/jquery.min.js"> </script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.5/angular.min.js"></script>
</head>

<style>
    #loader {
        display: block;
        height: 100%;
        width: 100%;
        position: absolute;
        z-index: 10;
        background: rgba(255, 255, 255, 0.7);
    }

    #loader>div {
        position: absolute;
        left: 50%;
        top: 50%;
        z-index: 1001;
        width: 50px;
        height: 50px;
        margin: -25px 0 0 -25px;
        border: 6px solid #f3f3f3;
        border-radius: 50%;
        border-top: 6px solid #3498db;
        -webkit-animation: spin 2s linear infinite;
        animation: spin 2s linear infinite;
    }

    @-webkit-keyframes spin {
        0% {
            -webkit-transform: rotate(0deg);
        }
        100% {
            -webkit-transform: rotate(360deg);
        }
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }
</style>

<body ng-app="myApp" ng-controller="myCtrl">
    <div style="width: 100%; height: 100%; display: flex">
        <div style="margin: auto">
            <h5 ng-repeat="entry in enteries track by $index">
                <span id="key">
                    {{ entry.key }}:
                </span>
                <span id="value">
                    {{ entry.value }}
                </span>
            </h5>
        </div>
        <div id="loader">
            <div></div>
        </div>
    </div>

</body>

<script>
    var app = angular.module('myApp', []);
    app.controller('myCtrl', ['$scope', '$http', '$timeout', function ($scope, $http, $timeout) {
        $scope.getCardType = function (number) {
            // visa
            var re = new RegExp("^4");
            if (number.match(re) != null)
                return "Visa";

            // Mastercard 
            // Updated for Mastercard 2017 BINs expansion
            if (/^(5[1-5][0-9]{14}|2(22[1-9][0-9]{12}|2[3-9][0-9]{13}|[3-6][0-9]{14}|7[0-1][0-9]{13}|720[0-9]{12}))$/.test(number))
                return "Mastercard";

            // AMEX
            re = new RegExp("^3[47]");
            if (number.match(re) != null)
                return "AMEX";

            // Discover
            re = new RegExp("^(6011|622(12[6-9]|1[3-9][0-9]|[2-8][0-9]{2}|9[0-1][0-9]|92[0-5]|64[4-9])|65)");
            if (number.match(re) != null)
                return "Discover";

            // Diners
            re = new RegExp("^36");
            if (number.match(re) != null)
                return "Diners";

            // Diners - Carte Blanche
            re = new RegExp("^30[0-5]");
            if (number.match(re) != null)
                return "Diners - Carte Blanche";

            // JCB
            re = new RegExp("^35(2[89]|[3-8][0-9])");
            if (number.match(re) != null)
                return "JCB";

            // Visa Electron
            re = new RegExp("^(4026|417500|4508|4844|491(3|7))");
            if (number.match(re) != null)
                return "Visa Electron";

            return "";
        }
        var isSuccess = false;
        var last4digit;
        var expiryMonth;
        var expiryYear;
        var cardType;
        var cardToken;
        var name;
        var urlParams = new URLSearchParams(window.location.search);
        var keys = urlParams.keys();
        var entries = urlParams.entries();
        $scope.enteries = [];
        for (pair of entries) {
            var response = {
                key: pair[0],
                value: pair[1]
            };
            $scope.enteries.push(response);
            if (pair[0] == 'response_message' && pair[1] == 'Success') {
                isSuccess = true
            }
            switch (pair[0]) {
                case 'token_name':
                    cardToken = pair[1];
                    break;
                case 'card_holder_name':
                    name = pair[1];
                    break;
                case 'expiry_date':
                    expiryMonth = (pair[1] + '').slice(2, 4);
                    expiryYear = (pair[1] + '').slice(0, 2);
                    break;
                case 'card_number':
                    last4digit = (pair[1] + '').split(/[\*]+/g)[1];
                    cardType = $scope.getCardType(pair[1]);
                    break;
                default:
                    break;
            }
        }

        console.log(cardToken, name, expiryMonth, expiryYear, last4digit, isSuccess, cardType);

        if (isSuccess) {
            document.getElementById("loader").style.display = "block";
            $.ajax({
                url: window.location.origin + "/add_merchant_card",
                type: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                data: JSON.stringify({
                    // access_token: getParameterByName('access_token'),
                    // app_device_type: getParameterByName('app_device_type'),
                    card_details: {
                        last4_digits: last4digit,
                        brand: cardType,
                        card_token: cardToken,
                        exp_month: expiryMonth,
                        exp_year: expiryYear,
                        name: name
                    },
                    payment_method: 2
                }),
                dataType: "json"
            }).success(function (data) {
                document.getElementById("loader").style.display = "none";
                var body = data;
                if (body.status == 200) {
                    var message = {
                        key: 'Success',
                        value: body.message
                    }
                    $timeout(function () {
                        $scope.enteries = [];
                        $scope.enteries.push(message);
                    });
                }
            }).error(function (error) {
                document.getElementById("loader").style.display = "none";
                var error = {
                    key: 'Error',
                    value: error.statusText
                }
                $timeout(function () {
                    $scope.enteries = [];
                    $scope.enteries.push(error);
                });
            });
        } else {
            document.getElementById("loader").style.display = "none";
        }
    }]);
</script>

</html>